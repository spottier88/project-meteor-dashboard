# API REST Meteor - Documentation

## üìã Vue d'ensemble

L'API REST Meteor permet d'interroger les donn√©es de projets, √©quipes, t√¢ches et risques de mani√®re programmatique. Cette API est con√ßue pour faciliter les int√©grations avec des syst√®mes externes (ERP, outils de reporting, dashboards personnalis√©s, etc.).

**URL de base de l'API :**
```
https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway
```

---

## üîê Authentification

Toutes les requ√™tes √† l'API n√©cessitent un token d'authentification. Deux m√©thodes sont support√©es :

### M√©thode 1 : Header X-API-Key (recommand√©e)
```bash
X-API-Key: votre_token_api
```

### M√©thode 2 : Authorization Bearer
```bash
Authorization: Bearer votre_token_api
```

### Obtenir un token API

1. Connectez-vous √† l'application Meteor
2. Acc√©dez √† **Administration** > **Tokens API**
3. Cliquez sur **Nouveau Token**
4. Configurez le nom, la date d'expiration et les p√©rim√®tres d'acc√®s
5. **Copiez le token imm√©diatement** (il ne sera plus affich√©)

‚ö†Ô∏è **Important** : Conservez vos tokens en lieu s√ªr. Ils donnent acc√®s √† vos donn√©es.

---

## üìç Endpoints disponibles

### 1. Liste des projets

R√©cup√®re la liste des projets accessibles selon les p√©rim√®tres du token.

**Endpoint :**
```
GET /api/projects
```

**Param√®tres de requ√™te (tous optionnels) :**

| Param√®tre | Type | Description | Exemple |
|-----------|------|-------------|---------|
| `status` | string | Filtrer par statut m√©t√©o | `green`, `orange`, `red` |
| `lifecycle_status` | string | Filtrer par statut du cycle de vie | `idea`, `planning`, `in_progress`, `on_hold`, `completed`, `cancelled` |
| `pole_id` | uuid | Filtrer par p√¥le | `a1b2c3d4-...` |
| `direction_id` | uuid | Filtrer par direction | `e5f6g7h8-...` |
| `service_id` | uuid | Filtrer par service | `i9j0k1l2-...` |
| `search` | string | Recherche textuelle sur le titre | `transformation` |
| `suivi_dgs` | boolean | Filtrer les projets DGS | `true`, `false` |
| `limit` | integer | Nombre de r√©sultats (max: 100) | `50` |
| `offset` | integer | D√©calage pour pagination | `0` |

**Exemple de requ√™te :**

```bash
curl -X GET "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway/api/projects?status=green&limit=10" \
  -H "X-API-Key: votre_token"
```

**Exemple de r√©ponse (200 OK) :**

```json
{
  "data": [
    {
      "id": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
      "title": "Transformation digitale des services",
      "description": "Modernisation des outils num√©riques",
      "status": "green",
      "lifecycle_status": "in_progress",
      "project_manager": "chef.projet@example.com",
      "project_manager_id": "uuid-du-manager",
      "start_date": "2025-01-01",
      "end_date": "2025-12-31",
      "pole_id": "pole-uuid",
      "direction_id": "direction-uuid",
      "service_id": "service-uuid",
      "suivi_dgs": true,
      "priority": "high",
      "poles": {
        "name": "P√¥le Innovation"
      },
      "directions": {
        "name": "Direction des Syst√®mes d'Information"
      },
      "services": {
        "name": "Service Num√©rique"
      }
    }
  ],
  "pagination": {
    "limit": 10,
    "offset": 0,
    "total": 42
  }
}
```

---

### 2. D√©tails d'un projet

R√©cup√®re les informations d√©taill√©es d'un projet sp√©cifique, incluant sa derni√®re revue et des statistiques.

**Endpoint :**
```
GET /api/projects/{project_id}
```

**Param√®tres :**
- `project_id` (path, requis) : UUID du projet

**Exemple de requ√™te :**

```bash
curl -X GET "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway/api/projects/a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6" \
  -H "X-API-Key: votre_token"
```

**Exemple de r√©ponse (200 OK) :**

```json
{
  "project": {
    "id": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
    "title": "Transformation digitale des services",
    "description": "Modernisation des outils num√©riques",
    "status": "green",
    "lifecycle_status": "in_progress",
    "project_manager": "chef.projet@example.com",
    "project_manager_id": "uuid-du-manager",
    "start_date": "2025-01-01",
    "end_date": "2025-12-31",
    "pole_id": "pole-uuid",
    "direction_id": "direction-uuid",
    "service_id": "service-uuid",
    "suivi_dgs": true,
    "priority": "high",
    "progress": "on_track",
    "last_review_date": "2025-10-20T10:30:00Z",
    "created_at": "2024-12-01T08:00:00Z",
    "updated_at": "2025-10-20T10:30:00Z",
    "poles": {
      "name": "P√¥le Innovation"
    },
    "directions": {
      "name": "Direction des Syst√®mes d'Information"
    },
    "services": {
      "name": "Service Num√©rique"
    }
  },
  "last_review": {
    "weather": "green",
    "progress": "on_track",
    "completion": 65,
    "created_at": "2025-10-20T10:30:00Z",
    "comment": "Le projet avance bien, respect du planning"
  },
  "statistics": {
    "team_members": 8,
    "tasks": 24,
    "risks": 3
  }
}
```

---

### 3. √âquipe d'un projet

R√©cup√®re la liste des membres de l'√©quipe d'un projet.

**Endpoint :**
```
GET /api/projects/{project_id}/team
```

**Param√®tres :**
- `project_id` (path, requis) : UUID du projet

**Exemple de requ√™te :**

```bash
curl -X GET "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway/api/projects/a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6/team" \
  -H "X-API-Key: votre_token"
```

**Exemple de r√©ponse (200 OK) :**

```json
{
  "data": [
    {
      "user_id": "user-uuid-1",
      "email": "alice.dupont@example.com",
      "first_name": "Alice",
      "last_name": "Dupont",
      "role": "secondary_manager",
      "joined_at": "2025-01-15T09:00:00Z"
    },
    {
      "user_id": "user-uuid-2",
      "email": "bob.martin@example.com",
      "first_name": "Bob",
      "last_name": "Martin",
      "role": "member",
      "joined_at": "2025-02-01T14:30:00Z"
    }
  ]
}
```

---

### 4. T√¢ches d'un projet

R√©cup√®re la liste des t√¢ches d'un projet avec des filtres optionnels.

**Endpoint :**
```
GET /api/projects/{project_id}/tasks
```

**Param√®tres :**
- `project_id` (path, requis) : UUID du projet

**Param√®tres de requ√™te (optionnels) :**

| Param√®tre | Type | Description | Valeurs possibles |
|-----------|------|-------------|-------------------|
| `status` | string | Filtrer par statut | `todo`, `in_progress`, `done`, `blocked` |
| `assignee` | string | Filtrer par assign√© | Email de l'utilisateur |

**Exemple de requ√™te :**

```bash
curl -X GET "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway/api/projects/a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6/tasks?status=in_progress" \
  -H "X-API-Key: votre_token"
```

**Exemple de r√©ponse (200 OK) :**

```json
{
  "data": [
    {
      "id": "task-uuid-1",
      "title": "D√©veloppement de l'interface utilisateur",
      "description": "Cr√©er les maquettes et impl√©menter les composants React",
      "status": "in_progress",
      "start_date": "2025-10-01",
      "due_date": "2025-10-31",
      "assignee": "dev@example.com",
      "parent_task_id": null,
      "created_at": "2025-09-15T10:00:00Z",
      "updated_at": "2025-10-20T15:30:00Z"
    },
    {
      "id": "task-uuid-2",
      "title": "Tests unitaires des composants",
      "description": "√âcrire les tests Jest pour les nouveaux composants",
      "status": "in_progress",
      "start_date": "2025-10-15",
      "due_date": "2025-10-25",
      "assignee": "qa@example.com",
      "parent_task_id": "task-uuid-1",
      "created_at": "2025-10-10T11:00:00Z",
      "updated_at": "2025-10-21T09:15:00Z"
    }
  ]
}
```

---

### 5. Risques d'un projet

R√©cup√®re la liste des risques identifi√©s pour un projet.

**Endpoint :**
```
GET /api/projects/{project_id}/risks
```

**Param√®tres :**
- `project_id` (path, requis) : UUID du projet

**Param√®tres de requ√™te (optionnels) :**

| Param√®tre | Type | Description | Valeurs possibles |
|-----------|------|-------------|-------------------|
| `status` | string | Filtrer par statut | `open`, `in_mitigation`, `closed` |
| `severity` | string | Filtrer par s√©v√©rit√© | `low`, `medium`, `high`, `critical` |
| `probability` | string | Filtrer par probabilit√© | `low`, `medium`, `high` |

**Exemple de requ√™te :**

```bash
curl -X GET "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway/api/projects/a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6/risks?status=open&severity=high" \
  -H "X-API-Key: votre_token"
```

**Exemple de r√©ponse (200 OK) :**

```json
{
  "data": [
    {
      "id": "risk-uuid-1",
      "description": "Retard potentiel d√ª √† la disponibilit√© des ressources",
      "probability": "medium",
      "severity": "high",
      "status": "open",
      "mitigation_plan": "Planifier une ressource de backup et anticiper les besoins",
      "created_at": "2025-09-01T10:00:00Z",
      "updated_at": "2025-10-15T14:30:00Z"
    },
    {
      "id": "risk-uuid-2",
      "description": "D√©pendance technologique critique sur un service externe",
      "probability": "low",
      "severity": "high",
      "status": "open",
      "mitigation_plan": "Pr√©voir une solution de secours et un plan de continuit√©",
      "created_at": "2025-09-10T09:00:00Z",
      "updated_at": "2025-10-01T11:20:00Z"
    }
  ]
}
```

---

## üìä Codes de r√©ponse HTTP

| Code | Signification | Description |
|------|---------------|-------------|
| `200` | OK | Requ√™te r√©ussie |
| `400` | Bad Request | Param√®tres invalides ou manquants |
| `401` | Unauthorized | Token manquant, invalide, expir√© ou inactif |
| `403` | Forbidden | Acc√®s refus√© (le token n'a pas acc√®s √† cette ressource) |
| `404` | Not Found | Ressource introuvable |
| `500` | Internal Server Error | Erreur serveur |

---

## ‚ùå Gestion des erreurs

Toutes les erreurs renvoient un objet JSON avec un champ `error` :

**Exemple d'erreur 401 (token invalide) :**
```json
{
  "error": "Invalid, expired or inactive API key"
}
```

**Exemple d'erreur 403 (acc√®s refus√©) :**
```json
{
  "error": "Access denied to this project"
}
```

**Exemple d'erreur 404 (projet introuvable) :**
```json
{
  "error": "Project not found or error fetching details"
}
```

**Exemple d'erreur 500 (erreur serveur) :**
```json
{
  "error": "Internal server error",
  "message": "Description d√©taill√©e de l'erreur"
}
```

---

## üîç P√©rim√®tres d'acc√®s (Scopes)

Les tokens API peuvent √™tre restreints √† des p√©rim√®tres sp√©cifiques :

### Types de donn√©es accessibles
- `projects` : Donn√©es des projets
- `team` : Membres des √©quipes
- `tasks` : T√¢ches des projets
- `risks` : Risques identifi√©s

### Restrictions organisationnelles
Un token peut √™tre restreint √† :
- Des **p√¥les** sp√©cifiques
- Des **directions** sp√©cifiques
- Des **services** sp√©cifiques
- Des **projets** sp√©cifiques

Si aucune restriction n'est configur√©e, le token a acc√®s √† toutes les donn√©es du type autoris√©.

---

## üöÄ Exemples d'utilisation

### Exemple en cURL

```bash
# R√©cup√©rer tous les projets en cours avec statut vert
curl -X GET "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway/api/projects?lifecycle_status=in_progress&status=green" \
  -H "X-API-Key: votre_token_api"
```

### Exemple en Python

```python
import requests

API_BASE_URL = "https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway"
API_TOKEN = "votre_token_api"

headers = {
    "X-API-Key": API_TOKEN
}

# R√©cup√©rer la liste des projets
response = requests.get(
    f"{API_BASE_URL}/api/projects",
    headers=headers,
    params={
        "lifecycle_status": "in_progress",
        "limit": 20
    }
)

if response.status_code == 200:
    data = response.json()
    print(f"Nombre de projets: {data['pagination']['total']}")
    for project in data['data']:
        print(f"- {project['title']} ({project['status']})")
else:
    print(f"Erreur: {response.json()['error']}")
```

### Exemple en JavaScript (Node.js)

```javascript
const axios = require('axios');

const API_BASE_URL = 'https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway';
const API_TOKEN = 'votre_token_api';

const headers = {
  'X-API-Key': API_TOKEN
};

async function getProjects() {
  try {
    const response = await axios.get(`${API_BASE_URL}/api/projects`, {
      headers,
      params: {
        lifecycle_status: 'in_progress',
        limit: 20
      }
    });
    
    console.log(`Nombre de projets: ${response.data.pagination.total}`);
    response.data.data.forEach(project => {
      console.log(`- ${project.title} (${project.status})`);
    });
  } catch (error) {
    console.error('Erreur:', error.response?.data?.error || error.message);
  }
}

getProjects();
```

### Exemple en PHP

```php
<?php

$apiBaseUrl = 'https://rgfabywkwllxoqsahrpt.supabase.co/functions/v1/api-gateway';
$apiToken = 'votre_token_api';

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $apiBaseUrl . '/api/projects?lifecycle_status=in_progress&limit=20');
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'X-API-Key: ' . $apiToken
]);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($httpCode === 200) {
    $data = json_decode($response, true);
    echo "Nombre de projets: " . $data['pagination']['total'] . "\n";
    foreach ($data['data'] as $project) {
        echo "- " . $project['title'] . " (" . $project['status'] . ")\n";
    }
} else {
    $error = json_decode($response, true);
    echo "Erreur: " . $error['error'] . "\n";
}
?>
```

---

## üìà Bonnes pratiques

### 1. S√©curit√©
- ‚úÖ **Ne jamais exposer** vos tokens dans le code source (utilisez des variables d'environnement)
- ‚úÖ **R√©voquer imm√©diatement** un token si vous suspectez une compromission
- ‚úÖ **D√©finir une date d'expiration** pour les tokens temporaires
- ‚úÖ **Utiliser le principe du moindre privil√®ge** : restreindre les p√©rim√®tres au minimum n√©cessaire

### 2. Performance
- ‚úÖ **Utiliser la pagination** pour les grandes listes de projets
- ‚úÖ **Filtrer c√¥t√© serveur** plut√¥t que de r√©cup√©rer toutes les donn√©es
- ‚úÖ **Mettre en cache** les r√©ponses API quand c'est pertinent

### 3. Gestion des erreurs
- ‚úÖ **Toujours v√©rifier** les codes de r√©ponse HTTP
- ‚úÖ **Impl√©menter des retry** avec backoff exponentiel en cas d'erreur 500
- ‚úÖ **Logger les erreurs** pour faciliter le d√©bogage

### 4. Monitoring
- ‚úÖ **Surveiller l'utilisation** de vos tokens depuis l'interface d'administration
- ‚úÖ **V√©rifier les logs d'API** pour d√©tecter les utilisations anormales
- ‚úÖ **D√©finir des alertes** en cas de taux d'erreur √©lev√©

---

## üîÑ Limites et quotas

| Limite | Valeur |
|--------|--------|
| Requ√™tes par token | Illimit√© (pour le moment) |
| Taille max de r√©ponse | 100 projets par requ√™te |
| Timeout de requ√™te | 30 secondes |
| Formats de r√©ponse | JSON uniquement |

> **Note** : Des limites de taux (rate limiting) pourront √™tre ajout√©es dans les versions futures.

---

## üìû Support

Pour toute question ou probl√®me concernant l'API :

1. Consultez d'abord cette documentation
2. V√©rifiez les logs d'API dans l'interface d'administration
3. Contactez l'√©quipe technique Meteor

---

## üÜï Changelog

### Version 1.0.0 (Octobre 2025)
- ‚ú® Lancement initial de l'API REST
- üìç 5 endpoints disponibles
- üîê Authentification par token API
- üéØ Support des p√©rim√®tres d'acc√®s configurables
- üìä Pagination et filtres avanc√©s

---

**Date de derni√®re mise √† jour** : 28 octobre 2025  
**Version de l'API** : 1.0.0
